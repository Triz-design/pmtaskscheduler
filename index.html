<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMs and Stat Testing Schedule</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.265.0/dist/umd/lucide.min.js"></script>

  <style>
    /* Small adjustments for print/pdf */
    @media print {
      .no-print { display: none !important; }
      body { 
        background-color: #fff !important; 
        background-image: none !important;
        padding: 20px !important;
      }
      .max-w-7xl { 
        max-width: 100% !important; 
        margin: 0 !important;
      }
      .bg-gradient-to-br { 
        background: white !important; 
      }
      .shadow-2xl, .shadow-xl, .shadow-md { 
        box-shadow: none !important; 
      }
      .border-t-4, .rounded-xl, .rounded-lg { 
        border: none !important;
        border-radius: 0 !important;
      }
      /* Print header */
      .print-header {
        display: block !important;
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 3px solid #4472C4;
        padding-bottom: 20px;
      }
      .print-logo {
        display: inline-block !important;
        max-width: 120px;
        max-height: 120px;
        margin-bottom: 10px;
      }
      /* Table styling for print */
      table {
        page-break-inside: auto;
        border-collapse: collapse;
        width: 100%;
      }
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      thead {
        display: table-header-group;
      }
      th {
        background-color: #4472C4 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 10px !important;
        font-size: 11px !important;
      }
      td {
        padding: 8px !important;
        font-size: 10px !important;
        border: 1px solid #ddd !important;
      }
      /* Status colors for print */
      .bg-red-100 {
        background-color: #fee !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .bg-green-100 {
        background-color: #efe !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .text-red-700 {
        color: #c00 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .text-green-700 {
        color: #060 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
    /* Ensure small font and monospace for dates */
    .small-pt { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; }

    /* Custom styles for dropdown */
    .dropdown-menu {
      z-index: 60;
    }
    
    /* Print header - hidden by default, shown only in print */
    .print-header {
      display: none;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6 font-sans">

  <div class="max-w-7xl mx-auto">

    <!-- Print Header (only visible when printing) -->
    <div class="print-header">
      <img id="printLogo" src="" alt="Company Logo" class="print-logo" />
      <h1 style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #333;">PMs and Stat Testing Schedule Report</h1>
      <p style="font-size: 12px; color: #666;" id="printDate"></p>
    </div>

    <!-- Header & Controls -->
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 mb-6 border-t-4 border-indigo-600">
      <div class="flex flex-wrap items-center justify-between gap-4">
        
        <!-- Logo and Title -->
        <div class="flex items-center gap-3 sm:gap-4">
          <div id="logoContainer" class="cursor-pointer relative group" onclick="document.getElementById('logoInput').click()">
            <img id="uploadedLogo" src="https://placehold.co/64x64/d0e0ff/333?text=LOGO" alt="Company Logo" class="h-14 w-14 sm:h-16 sm:w-16 object-contain rounded-full border-2 border-indigo-200 p-1" />
            <input type="file" id="logoInput" accept="image/*" class="hidden" />
          </div>
          <div class="flex flex-col gap-1">
            <h1 class="text-xl sm:text-3xl font-extrabold text-gray-800">PMs and Stat Testing Schedule</h1>
            <div class="flex gap-2 items-center no-print">
              <label for="logoInput" class="text-indigo-500 hover:text-indigo-700 cursor-pointer text-xs sm:text-sm font-medium hover:underline">Change Logo</label>
              <span class="text-gray-400">|</span>
              <button onclick="removeLogo()" class="text-red-500 hover:text-red-700 cursor-pointer text-xs sm:text-sm font-medium hover:underline">Remove Logo</button>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-2 flex-wrap justify-end no-print">
          
          <button id="importBtn" class="flex items-center px-3 py-2 text-sm bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150">
            <i data-lucide="upload" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2"></i> Load Schedule Data
          </button>
          <input type="file" id="importFileInput" accept=".json" class="hidden" />

          <button id="reminderSettingsBtn" class="flex items-center px-3 py-2 text-sm bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150">
            <i data-lucide="settings" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2"></i> Settings
          </button>

          <button id="sendReminderBtn" class="flex items-center px-3 py-2 text-sm bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">
            <i data-lucide="mail" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2"></i> Send Reminder
          </button>

          <button id="startFreshBtn" class="flex items-center px-3 py-2 text-sm bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 transition duration-150">
            <i data-lucide="trash" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2"></i> Start Fresh
          </button>
          
          <button id="addClientBtn" class="flex items-center px-3 py-2 text-sm bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
            <i data-lucide="user-plus" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2"></i> Add Client
          </button>

          <!-- Export Dropdown -->
          <div class="relative inline-block text-left" id="exportDropdownContainer">
            <button id="exportDropdownBtn" class="flex items-center px-3 py-2 text-sm bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition duration-150" type="button">
              <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2"></i> Export
              <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
            </button>
            <div id="exportDropdownMenu" class="dropdown-menu absolute right-0 mt-2 w-48 rounded-lg shadow-xl bg-white ring-1 ring-black ring-opacity-5 hidden">
              <div class="py-1">
                <a href="#" onclick="event.preventDefault(); exportData('json')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                  <i data-lucide="code" class="w-4 h-4 mr-2"></i> Save Schedule Data
                </a>
                <a href="#" onclick="event.preventDefault(); exportData('csv')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                  <i data-lucide="list-ordered" class="w-4 h-4 mr-2"></i> Export to CSV
                </a>
                <a href="#" onclick="event.preventDefault(); exportData('aroflo')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                  <i data-lucide="file-down" class="w-4 h-4 mr-2"></i> AROFLO CSV
                </a>
                <a href="#" onclick="event.preventDefault(); exportData('excel')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                  <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i> Export to Excel (XML)
                </a>
                <a href="#" onclick="event.preventDefault(); exportData('pdf')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 border-t mt-1 pt-1">
                  <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Print to PDF
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6 no-print">
      <div class="relative">
        <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <input type="text" id="searchInput" placeholder="Search by client name, job type, or task..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-xl shadow-inner focus:ring-indigo-500 focus:border-indigo-500 w-full" />
      </div>
      <div class="mt-2 flex gap-2 flex-wrap">
        <button onclick="filterOverdue()" class="text-xs px-3 py-1.5 bg-red-100 text-red-700 border border-red-300 rounded-lg hover:bg-red-200 transition font-medium flex items-center">
          <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i> Show Overdue Only
        </button>
        <button onclick="filterDueSoon()" class="text-xs px-3 py-1.5 bg-orange-100 text-orange-700 border border-orange-300 rounded-lg hover:bg-orange-200 transition font-medium flex items-center">
          <i data-lucide="clock" class="w-3 h-3 mr-1"></i> Show Due Within 14 Days
        </button>
        <button onclick="filterInDate()" class="text-xs px-3 py-1.5 bg-green-100 text-green-700 border border-green-300 rounded-lg hover:bg-green-200 transition font-medium flex items-center">
          <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i> Show In Date Only
        </button>
        <button onclick="clearFilters()" class="text-xs px-3 py-1.5 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-200 transition font-medium flex items-center">
          <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i> Clear Filters
        </button>
      </div>
    </div>

    <!-- Filter Alerts -->
    <div id="overdueAlert" class="hidden bg-red-50 border-l-4 border-red-400 text-red-800 p-4 rounded-lg mb-6 shadow-md text-sm">
      <div class="flex items-start">
        <i data-lucide="alert-circle" class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5"></i>
        <div>
          <p class="font-bold">Overdue Tasks</p>
          <p class="text-xs mt-1" id="overdueCount">Showing tasks that are past their due date.</p>
        </div>
      </div>
    </div>

    <!-- Due Soon Alert -->
    <div id="dueSoonAlert" class="hidden bg-orange-50 border-l-4 border-orange-400 text-orange-800 p-4 rounded-lg mb-6 shadow-md text-sm">
      <div class="flex items-start">
        <i data-lucide="alert-circle" class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5"></i>
        <div>
          <p class="font-bold">Tasks Due Within 14 Days</p>
          <p class="text-xs mt-1" id="dueSoonCount">Showing tasks that are due within the next 14 days.</p>
        </div>
      </div>
    </div>

    <div id="inDateAlert" class="hidden bg-green-50 border-l-4 border-green-400 text-green-800 p-4 rounded-lg mb-6 shadow-md text-sm">
      <div class="flex items-start">
        <i data-lucide="check-circle" class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5"></i>
        <div>
          <p class="font-bold">In Date Tasks</p>
          <p class="text-xs mt-1" id="inDateCount">Showing tasks that are currently in date (not overdue).</p>
        </div>
      </div>
    </div>

    <!-- Help & Instructions Panel -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-indigo-600 p-4 rounded-lg mb-6 shadow-md no-print">
      <div class="flex items-start gap-3">
        <i data-lucide="info" class="w-6 h-6 text-indigo-600 flex-shrink-0 mt-0.5"></i>
        <div class="flex-1">
          <h3 class="font-bold text-indigo-900 text-lg mb-2">Quick Guide & Important Reminder</h3>
          
          <!-- Save Reminder -->
          <div class="bg-red-50 border border-red-200 rounded-md p-3 mb-3">
            <p class="text-red-800 font-semibold text-sm flex items-center gap-2">
              <i data-lucide="alert-circle" class="w-4 h-4"></i>
              <span>‚ö†Ô∏è IMPORTANT: Remember to regularly save your database using the "Export ‚Üí Save Schedule Data" button to back up your data!</span>
            </p>
          </div>

          <!-- Button Guide -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="bg-white rounded-md p-3 border border-gray-200">
              <p class="font-semibold text-gray-800 mb-1">üìÑ Load Schedule Data</p>
              <p class="text-gray-600 text-xs">Import a previously saved database file (.json) to restore your client records and scheduled tasks.</p>
            </div>
            
            <div class="bg-white rounded-md p-3 border border-gray-200">
              <p class="font-semibold text-gray-800 mb-1">‚öôÔ∏è Settings</p>
              <p class="text-gray-600 text-xs">Configure email addresses for reminder recipients. <strong>Note:</strong> This is for record-keeping only - the system does not send automated emails.</p>
            </div>
            
            <div class="bg-white rounded-md p-3 border border-gray-200">
              <p class="font-semibold text-gray-800 mb-1">‚ûï Add Client</p>
              <p class="text-gray-600 text-xs">Add a new client to the system along with their scheduled PM and stat testing tasks.</p>
            </div>
            
            <div class="bg-white rounded-md p-3 border border-gray-200">
              <p class="font-semibold text-gray-800 mb-1">üíæ Export/Save</p>
              <p class="text-gray-600 text-xs">
                <strong>Save Database:</strong> Backup all data to a .json file<br/>
                <strong>Export to CSV/Excel:</strong> Create reports for viewing in spreadsheet programs<br/>
                <strong>Print to PDF:</strong> Generate a professional printable report
              </p>
            </div>
            
            <div class="bg-white rounded-md p-3 border border-green-200 bg-green-50">
              <p class="font-semibold text-green-800 mb-1">‚úÖ Quick Update (NEW!)</p>
              <p class="text-gray-600 text-xs">Click the green checkmark icon next to any task to quickly update completion dates without opening the full edit form.</p>
            </div>
          </div>

          <!-- Reminder Recipients Explanation -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mt-3">
            <p class="text-yellow-800 text-xs">
              <strong>About Reminder Recipients:</strong> The email addresses you enter in Settings are stored for your reference and planning purposes only. This system <strong>does not automatically send emails</strong>. You'll need to manually send reminders to these recipients about upcoming tasks.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reminder Summary -->
    <div id="reminderSummary" class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-6 shadow-md text-sm no-print">
      <div class="flex items-start">
        <i data-lucide="alert-triangle" class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5"></i>
        <div>
          <p class="font-bold">Reminder Recipients:</p>
          <p class="text-xs" id="recipientListDisplay">No recipients set. Click 'Settings' to configure email reminders.</p>
        </div>
      </div>
    </div>

    <!-- Main Table -->
    <div class="bg-white rounded-xl shadow-2xl overflow-x-auto border-2 border-gray-100">
      <table id="taskTable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50 sticky top-0 z-10">
          <tr>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Type & Task</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Test Completed</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Due Date</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days Remaining</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Actions</th>
          </tr>
        </thead>
        <tbody id="taskTableBody" class="bg-white divide-y divide-gray-200 small-pt">
          <!-- Table rows will be rendered here -->
        </tbody>
      </table>
      <div id="noResults" class="hidden text-center p-8 text-gray-500">
        <i data-lucide="folder-open" class="w-8 h-8 mx-auto mb-2"></i>
        <p>No clients or tasks found matching your criteria.</p>
      </div>
    </div>
  </div>

  <!-- Modal Template for Form/Report/Error -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div id="modalContent" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 duration-300">
      <!-- Modal content (form, settings, or confirmation) will be injected here -->
    </div>
  </div>


<script>
// ====================================================================
  // 1. GLOBAL STATE & TYPES
  // ====================================================================

  let clients = [];
  let logoBase64 = '';
  let reminderEmails = [];
  let emailJsServiceId = '';
  let emailJsTemplateId = '';
  let emailJsPublicKey = '';
  let searchTerm = '';
  let filterMode = 'all';

  let isModalOpen = false;
  let currentClient = null;
  let isEditing = false;
  let initialTaskIndex = -1;

  let pendingDeleteType = null;
  let pendingDeleteClientId = null;
  let pendingDeleteTaskId = null;

  const taskTableBody = document.getElementById('taskTableBody');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalContent = document.getElementById('modalContent');
  const logoInput = document.getElementById('logoInput');
  const searchInput = document.getElementById('searchInput');

  // ====================================================================
  // 2. UTILITY FUNCTIONS
  // ====================================================================

  function generateId() {
    return 'id_' + Math.random().toString(36).substring(2, 9);
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString.replace(/-/g, '/'));
      return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch {
      return 'Invalid Date';
    }
  }

  function getDaysRemaining(targetDateString) {
    if (!targetDateString) return Infinity;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const target = new Date(targetDateString.replace(/-/g, '/'));
    target.setHours(0, 0, 0, 0);
    const _MS_PER_DAY = 1000 * 60 * 60 * 24;
    return Math.ceil((target.getTime() - today.getTime()) / _MS_PER_DAY);
  }

  function getTaskStatus(days) {
    if (days < 0) {
      return { statusText: 'OVERDUE', statusClass: 'bg-red-100 text-red-700 font-bold border-red-300' };
    } else {
      return { statusText: 'IN DATE', statusClass: 'bg-green-100 text-green-700 font-semibold border-green-300' };
    }
  }

  // ====================================================================
  // 3. PERSISTENCE (Local Storage)
  // ====================================================================

  function getCurrentData() {
    return {
      clients,
      logoBase64,
      reminderEmails,
      emailJsServiceId,
      emailJsTemplateId,
      emailJsPublicKey,
      savedDate: new Date().toISOString()
    };
  }

  function saveToLocalStorage() {
    try {
      localStorage.setItem("scheduleData", JSON.stringify(getCurrentData()));
    } catch (err) {
      console.error("Error saving data:", err);
    }
  }

  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem("scheduleData");
      if (saved) {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed.clients)) {
          clients = parsed.clients;
        }
        if (parsed.logoBase64) {
          logoBase64 = parsed.logoBase64;
        }
        if (Array.isArray(parsed.reminderEmails)) {
          reminderEmails = parsed.reminderEmails;
        }
        if (parsed.emailJsServiceId) {
          emailJsServiceId = parsed.emailJsServiceId;
        }
        if (parsed.emailJsTemplateId) {
          emailJsTemplateId = parsed.emailJsTemplateId;
        }
        if (parsed.emailJsPublicKey) {
          emailJsPublicKey = parsed.emailJsPublicKey;
        }
      }
    } catch (err) {
      console.error("Error loading saved data:", err);
    }
  }

  function saveAndRender() {
    saveToLocalStorage();
    renderTable();
    updateReminderSummary();
  }

  // ====================================================================
  // 4. MODAL HANDLER
  // ====================================================================

  function openModal(title, innerHtml) {
    const modalHtml = `
      <div class="flex justify-between items-center pb-3 border-b border-gray-200">
        <h3 class="text-2xl font-semibold text-gray-900">${title}</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 rounded-full p-2 transition">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="mt-4 max-h-[80vh] overflow-y-auto pr-2">
        ${innerHtml}
      </div>
    `;
    modalContent.innerHTML = modalHtml;
    modalBackdrop.classList.remove('hidden');
    isModalOpen = true;
    if (window.lucide) { window.lucide.createIcons(); }
  }

  function closeModal() {
    modalBackdrop.classList.add('hidden');
    modalContent.innerHTML = '';
    isModalOpen = false;
    currentClient = null;
    pendingDeleteType = null;
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isModalOpen) {
      closeModal();
    }
  });

  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) {
      closeModal();
    }
  });

  // ====================================================================
  // 5. CLIENT CRUD & RENDER FUNCTIONS
  // ====================================================================

  function renderHeaderLogo() {
    const logoEl = document.getElementById("uploadedLogo");
    if (logoEl) {
      logoEl.src = logoBase64 || "https://placehold.co/64x64/d0e0ff/333?text=LOGO";
    }
  }

  function updateReminderSummary() {
    const displayEl = document.getElementById('recipientListDisplay');
    if (displayEl) {
      displayEl.innerHTML = reminderEmails.length > 0 
        ? `<span class="mono">${reminderEmails.join(', ')}</span>`
        : `No recipients set. Click Settings to configure email reminders.`;
    }
  }

  function renderTable() {
    const filteredClients = getFilteredClients();

    document.getElementById('overdueAlert').classList.add('hidden');
    document.getElementById('dueSoonAlert').classList.add('hidden');
    document.getElementById('inDateAlert').classList.add('hidden');

    if (filterMode === 'overdue') {
      const totalOverdueTasks = filteredClients.reduce((sum, client) => sum + client.tasks.length, 0);
      document.getElementById('overdueAlert').classList.remove('hidden');
      document.getElementById('overdueCount').textContent = 
        `Found ${totalOverdueTasks} overdue task${totalOverdueTasks !== 1 ? 's' : ''} across ${filteredClients.length} client${filteredClients.length !== 1 ? 's' : ''}.`;
    } else if (filterMode === 'dueSoon') {
      const totalDueSoonTasks = filteredClients.reduce((sum, client) => sum + client.tasks.length, 0);
      document.getElementById('dueSoonAlert').classList.remove('hidden');
      document.getElementById('dueSoonCount').textContent = 
        `Found ${totalDueSoonTasks} task${totalDueSoonTasks !== 1 ? 's' : ''} due within the next 14 days across ${filteredClients.length} client${filteredClients.length !== 1 ? 's' : ''}.`;
    } else if (filterMode === 'inDate') {
      const totalInDateTasks = filteredClients.reduce((sum, client) => sum + client.tasks.length, 0);
      document.getElementById('inDateAlert').classList.remove('hidden');
      document.getElementById('inDateCount').textContent = 
        `Found ${totalInDateTasks} in date task${totalInDateTasks !== 1 ? 's' : ''} across ${filteredClients.length} client${filteredClients.length !== 1 ? 's' : ''}.`;
    }

    taskTableBody.innerHTML = '';

    if (filteredClients.length === 0) {
      document.getElementById('noResults').classList.remove('hidden');
      return;
    } else {
      document.getElementById('noResults').classList.add('hidden');
    }

    let rowsHtml = '';
    filteredClients.forEach(client => {
      if (client.tasks.length === 0) {
        rowsHtml += createRowHtml(client, null, true);
        return;
      }
      client.tasks.forEach((task, index) => {
        const isFirstTask = index === 0;
        rowsHtml += createRowHtml(client, task, isFirstTask);
      });
    });
    
    taskTableBody.innerHTML = rowsHtml;
    if (window.lucide) { window.lucide.createIcons(); }
  }

  function createRowHtml(client, task, isFirstTask) {
    const rowSpan = isFirstTask ? client.tasks.length || 1 : 0;
    let days = task ? getDaysRemaining(task.nextDue) : Infinity;
    let status = getTaskStatus(days);
    const clientIdEscaped = String(client.id).replace(/'/g, "\\'");
    const taskIdEscaped = task ? String(task.id).replace(/'/g, "\\'") : '';
    
    const clientInfoHtml = `
      <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900" ${isFirstTask ? `rowspan="${rowSpan}"` : ''}>
        <p class="font-semibold">${client.clientName}</p>
        <p class="text-xs text-gray-500">${client.contactPerson || 'N/A'}</p>
        <p class="text-xs text-gray-500">${client.email}</p>
        <div class="mt-2 flex gap-2 no-print">
          <button onclick="handleOpenForm('${clientIdEscaped}')" class="text-xs text-indigo-500 hover:underline border border-indigo-200 rounded-md px-2 py-0.5"><i data-lucide="edit-2" class="w-3 h-3 inline mr-1"></i> Edit Info</button>
          <button onclick="confirmDeleteClient('${clientIdEscaped}')" class="text-xs text-red-500 hover:underline border border-red-200 rounded-md px-2 py-0.5"><i data-lucide="user-x" class="w-3 h-3 inline mr-1"></i> Delete</button>
        </div>
      </td>
    `;

    if (!task) {
      return `
        <tr class="hover:bg-gray-50">
          ${clientInfoHtml}
          <td class="px-3 py-2 text-gray-400 italic" colspan="5">No tasks recorded.</td>
          <td class="px-3 py-2 whitespace-nowrap text-center no-print">
            <button onclick="handleOpenForm('${clientIdEscaped}', true)" class="text-green-600 hover:text-green-800"><i data-lucide="plus" class="w-4 h-4 inline"></i> Add Task</button>
          </td>
        </tr>`;
    }

    const taskCells = `
      <td class="px-3 py-2 text-gray-800">
        <p class="font-medium">${task.type}</p>
        <p class="text-xs text-gray-500">${task.details || 'N/A'}</p>
      </td>
      <td class="px-3 py-2 whitespace-nowrap text-gray-500 mono">${formatDate(task.lastCompleted)}</td>
      <td class="px-3 py-2 whitespace-nowrap text-gray-500 mono">${formatDate(task.nextDue)}</td>
      <td class="px-3 py-2 whitespace-nowrap text-center font-bold text-sm ${status.statusClass}">
        ${days < 0 ? Math.abs(days) + ' days overdue' : (days === Infinity ? 'N/A' : days + ' days')}
      </td>
      <td class="px-3 py-2 whitespace-nowrap font-bold text-xs border-l-2 ${status.statusClass}">
        ${status.statusText}
      </td>
      <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-medium no-print">
        <button onclick="openUpdateTaskModal('${clientIdEscaped}', '${taskIdEscaped}')" class="text-green-600 hover:text-green-900 mr-2" title="Update Task"><i data-lucide="check-circle" class="w-4 h-4 inline"></i></button>
        <button onclick="handleOpenForm('${clientIdEscaped}', false, '${taskIdEscaped}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Edit Task"><i data-lucide="edit-2" class="w-4 h-4 inline"></i></button>
        <button onclick="confirmDeleteTask('${clientIdEscaped}', '${taskIdEscaped}')" class="text-red-600 hover:text-red-900" title="Delete Task"><i data-lucide="trash-2" class="w-4 h-4 inline"></i></button>
      </td>
    `;

    if (isFirstTask) {
      return `<tr class="hover:bg-gray-50">${clientInfoHtml}${taskCells}</tr>`;
    } else {
      return `<tr class="hover:bg-gray-50">${taskCells}</tr>`;
    }
  }

  // ====================================================================
  // 6. FORM & MODAL RENDERING
  // ====================================================================

  function handleOpenForm(clientId, addTask = false, taskId = null) {
    currentClient = clientId ? clients.find(c => c.id === clientId) : null;
    isEditing = !!currentClient;
    initialTaskIndex = addTask ? 0 : -1;
    renderForm();
  }

  function renderForm() {
    const client = currentClient || {
      id: generateId(),
      clientName: '', contactPerson: '', email: '', phone: '',
      tasks: []
    };
    
    const tasks = client.tasks.map(task => ({...task}));
    if (initialTaskIndex !== -1 || tasks.length === 0) {
      if (tasks.length === 0 || initialTaskIndex !== -1) {
        tasks.push({ id: generateId(), type: 'PM', details: '', lastCompleted: '', nextDue: '' });
      }
    }

    const tasksHtml = tasks.map(task => createTaskInputHtml(task)).join('');

    const innerHtml = `
      <form id="clientForm">
        <div class="space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="sm:col-span-2">
              <label for="clientName" class="block text-sm font-medium text-gray-700">Client Name</label>
              <input type="text" id="clientName" value="${client.clientName}" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
              <label for="contactPerson" class="block text-sm font-medium text-gray-700">Contact Person</label>
              <input type="text" id="contactPerson" value="${client.contactPerson || ''}" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
              <input type="email" id="email" value="${client.email}" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div class="sm:col-span-2">
              <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
              <input type="text" id="phone" value="${client.phone}" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
          </div>
          <div class="border-t pt-4">
            <h4 class="text-xl font-bold text-gray-800 mb-3 flex justify-between items-center">
              Scheduled Tasks
              <button type="button" onclick="addTaskRowToForm()" class="text-xs flex items-center px-2 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                <i data-lucide="plus" class="w-3 h-3 mr-1"></i> Add Task
              </button>
            </h4>
            <div id="tasksContainer" class="space-y-4">
              ${tasksHtml}
            </div>
          </div>
          <div class="pt-4 flex justify-end gap-3">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 flex items-center">
              <i data-lucide="save" class="w-5 h-5 mr-2"></i> ${isEditing ? 'Save Changes' : 'Add Client'}
            </button>
          </div>
        </div>
      </form>
    `;
    openModal(isEditing ? `Edit ${client.clientName}` : 'Add New Client', innerHtml);

    document.getElementById('clientForm').onsubmit = (e) => {
      e.preventDefault();
      saveForm();
    };
  }

  function createTaskInputHtml(task) {
    const taskTypes = ['PM', 'Stat Testing', 'Maintenance'];
    const optionsHtml = taskTypes.map(type => 
      `<option value="${type}" ${task.type === type ? 'selected' : ''}>${type}</option>`
    ).join('');

    return `
      <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 shadow-sm" data-task-id="${task.id}">
        <input type="hidden" name="taskId" value="${task.id}" />
        <div class="flex justify-end mb-2">
          <button type="button" onclick="removeTaskInput(this)" class="text-red-500 hover:text-red-700 rounded-full p-1 transition" title="Remove Task">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600">Job Type</label>
            <select name="taskType" class="block w-full border border-gray-300 rounded-md p-1.5 text-sm" required>
              ${optionsHtml}
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600">Last Test Completed</label>
            <input type="date" name="taskLastCompleted" value="${task.lastCompleted}" class="block w-full border border-gray-300 rounded-md p-1.5 text-sm" required />
          </div>
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-600">Task Details / Description</label>
            <input type="text" name="taskDetails" value="${task.details}" placeholder="e.g. Fire Alarm Annual Test or Boiler Service" maxlength="50" class="block w-full border border-gray-300 rounded-md p-1.5 text-sm" />
            <p class="text-xs text-gray-500 mt-1">Maximum 50 characters</p>
          </div>
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-600">Next Due Date</label>
            <input type="date" name="taskNextDue" value="${task.nextDue}" class="block w-full border border-gray-300 rounded-md p-1.5 text-sm" required />
          </div>
        </div>
      </div>
    `;
  }

  function addTaskRowToForm() {
    const tasksContainer = document.getElementById('tasksContainer');
    if (tasksContainer) {
      tasksContainer.insertAdjacentHTML('beforeend', createTaskInputHtml({ 
        id: generateId(), 
        type: 'PM', 
        details: '', 
        lastCompleted: new Date().toISOString().substring(0, 10),
        nextDue: '' 
      }));
      if (window.lucide) { window.lucide.createIcons(); }
    }
  }

  function removeTaskInput(button) {
    const taskDiv = button.closest('[data-task-id]');
    if (taskDiv) {
      taskDiv.remove();
    }
  }

  function saveForm() {
    const form = document.getElementById('clientForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    const clientName = form.querySelector('#clientName').value.trim();
    const contactPerson = form.querySelector('#contactPerson').value.trim();
    const email = form.querySelector('#email').value.trim();
    const phone = form.querySelector('#phone').value.trim();
    const taskInputs = Array.from(form.querySelectorAll('[data-task-id]'));

    const newTasks = taskInputs.map(taskDiv => ({
      id: taskDiv.querySelector('[name="taskId"]').value,
      type: taskDiv.querySelector('[name="taskType"]').value,
      details: taskDiv.querySelector('[name="taskDetails"]').value.trim(),
      lastCompleted: taskDiv.querySelector('[name="taskLastCompleted"]').value,
      nextDue: taskDiv.querySelector('[name="taskNextDue"]').value,
    })).filter(task => task.nextDue && task.lastCompleted);

    let clientToSave = {
      id: isEditing ? currentClient.id : generateId(),
      clientName, contactPerson, email, phone,
      tasks: newTasks,
    };

    if (isEditing) {
      const clientIndex = clients.findIndex(c => c.id === clientToSave.id);
      if (clientIndex !== -1) {
        clients[clientIndex] = clientToSave;
      }
    } else {
      clients.push(clientToSave);
    }
    
    closeModal();
    saveAndRender();
  }

  // ====================================================================
  // 7. DELETION HANDLERS
  // ====================================================================

  function confirmDeleteClient(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    pendingDeleteType = 'client';
    pendingDeleteClientId = clientId;
    renderConfirmModal(
      'Confirm Client Deletion',
      `Are you sure you want to permanently delete **${client.clientName}** and all ${client.tasks.length} of their associated tasks? This cannot be undone.`
    );
  }

  function confirmDeleteTask(clientId, taskId) {
    const client = clients.find(c => c.id === clientId);
    const task = client ? client.tasks.find(t => t.id === taskId) : null;
    if (!client || !task) return;
    pendingDeleteType = 'task';
    pendingDeleteClientId = clientId;
    pendingDeleteTaskId = taskId;
    renderConfirmModal(
      'Confirm Task Deletion',
      `Are you sure you want to delete the **${task.type}: ${task.details}** task for ${client.clientName}?`
    );
  }

  function renderConfirmModal(title, message) {
    const innerHtml = `
      <div class="text-lg text-gray-700 mb-6">
        <p>${message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
      </div>
      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
        <button type="button" onclick="executePendingDelete()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">
          Yes, Delete
        </button>
      </div>
    `;
    openModal(title, innerHtml);
  }

  function executePendingDelete() {
    if (pendingDeleteType === 'client') {
      const index = clients.findIndex(c => c.id === pendingDeleteClientId);
      if (index !== -1) {
        clients.splice(index, 1);
      }
    } else if (pendingDeleteType === 'task') {
      const client = clients.find(c => c.id === pendingDeleteClientId);
      if (client) {
        client.tasks = client.tasks.filter(t => t.id !== pendingDeleteTaskId);
      }
    }
    closeModal();
    saveAndRender();
  }

  // ====================================================================
  // 8. UPDATE TASK MODAL
  // ====================================================================

  function openUpdateTaskModal(clientId, taskId) {
    const client = clients.find(c => c.id === clientId);
    const task = client ? client.tasks.find(t => t.id === taskId) : null;
    
    if (!client || !task) {
      console.error('Client or task not found');
      return;
    }

    // Calculate the interval (in days) from last completion to next due
    const lastCompletedDate = new Date(task.lastCompleted.replace(/-/g, '/'));
    const nextDueDate = new Date(task.nextDue.replace(/-/g, '/'));
    const intervalDays = Math.round((nextDueDate - lastCompletedDate) / (1000 * 60 * 60 * 24));
    
    // Default new completion date to today
    const today = new Date().toISOString().substring(0, 10);
    
    // Calculate suggested next due date (today + interval)
    const suggestedNextDue = new Date();
    suggestedNextDue.setDate(suggestedNextDue.getDate() + intervalDays);
    const suggestedNextDueStr = suggestedNextDue.toISOString().substring(0, 10);

    const innerHtml = `
      <form id="updateTaskForm">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200 mb-4">
          <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
            <div>
              <h4 class="font-bold text-green-900 text-sm mb-1">Quick Task Update</h4>
              <p class="text-xs text-green-700">Update this task's completion date and set the next due date.</p>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <!-- Current Task Info -->
          <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
            <p class="text-sm font-semibold text-gray-700 mb-2">Current Task Details:</p>
            <div class="text-xs text-gray-600 space-y-1">
              <p><strong>Client:</strong> ${client.clientName}</p>
              <p><strong>Task Type:</strong> ${task.type}</p>
              <p><strong>Task Details:</strong> ${task.details || 'N/A'}</p>
              <p><strong>Previous Completion:</strong> ${formatDate(task.lastCompleted)}</p>
              <p><strong>Current Due Date:</strong> ${formatDate(task.nextDue)}</p>
              <p class="text-indigo-600 font-semibold pt-1 border-t border-gray-300 mt-2">
                <i data-lucide="calendar" class="w-3 h-3 inline"></i> Interval: ${intervalDays} days
              </p>
            </div>
          </div>

          <!-- New Completion Date -->
          <div>
            <label for="newCompletionDate" class="block text-sm font-medium text-gray-700 mb-1">
              New Completion Date <span class="text-red-500">*</span>
            </label>
            <input 
              type="date" 
              id="newCompletionDate" 
              value="${today}" 
              required 
              max="${today}"
              class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-green-500 focus:border-green-500" 
            />
            <p class="text-xs text-gray-500 mt-1">When was this task completed?</p>
          </div>

          <!-- Next Due Date -->
          <div>
            <label for="newNextDueDate" class="block text-sm font-medium text-gray-700 mb-1">
              Next Due Date <span class="text-red-500">*</span>
            </label>
            <input 
              type="date" 
              id="newNextDueDate" 
              value="${suggestedNextDueStr}" 
              required 
              class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-green-500 focus:border-green-500" 
            />
            <p class="text-xs text-gray-500 mt-1">
              Suggested: ${formatDate(suggestedNextDueStr)} (${intervalDays} days from completion)
            </p>
          </div>

          <!-- Auto-calculate checkbox -->
          <div class="flex items-center gap-2 bg-indigo-50 p-3 rounded-lg border border-indigo-200">
            <input 
              type="checkbox" 
              id="autoCalculateNextDue" 
              checked 
              class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
            />
            <label for="autoCalculateNextDue" class="text-xs text-indigo-800">
              <i data-lucide="calculator" class="w-3 h-3 inline"></i> 
              Auto-calculate next due date based on ${intervalDays}-day interval
            </label>
          </div>

          <!-- Action Buttons -->
          <div class="pt-4 flex justify-end gap-3 border-t">
            <button 
              type="button" 
              onclick="closeModal()" 
              class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
            <button 
              type="submit" 
              class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 flex items-center"
            >
              <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Update Task
            </button>
          </div>
        </div>
      </form>
    `;

    openModal(`Update Task: ${task.type}`, innerHtml);

    // Add event listeners for auto-calculation
    const completionInput = document.getElementById('newCompletionDate');
    const nextDueInput = document.getElementById('newNextDueDate');
    const autoCalcCheckbox = document.getElementById('autoCalculateNextDue');

    completionInput.addEventListener('change', () => {
      if (autoCalcCheckbox.checked) {
        const completionDate = new Date(completionInput.value);
        completionDate.setDate(completionDate.getDate() + intervalDays);
        nextDueInput.value = completionDate.toISOString().substring(0, 10);
      }
    });

    autoCalcCheckbox.addEventListener('change', () => {
      if (autoCalcCheckbox.checked) {
        const completionDate = new Date(completionInput.value);
        completionDate.setDate(completionDate.getDate() + intervalDays);
        nextDueInput.value = completionDate.toISOString().substring(0, 10);
      }
    });

    // Handle form submission
    document.getElementById('updateTaskForm').onsubmit = (e) => {
      e.preventDefault();
      
      const newCompletionDate = completionInput.value;
      const newNextDueDate = nextDueInput.value;

      if (!newCompletionDate || !newNextDueDate) {
        alert('Please fill in all required fields.');
        return;
      }

      // Validate that next due date is after completion date
      if (new Date(newNextDueDate) <= new Date(newCompletionDate)) {
        alert('Next due date must be after the completion date.');
        return;
      }

      // Update the task
      task.lastCompleted = newCompletionDate;
      task.nextDue = newNextDueDate;

      closeModal();
      saveAndRender();

      // Show success message
      setTimeout(() => {
        openModal('Task Updated Successfully', `
          <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
              <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
            </div>
            <p class="text-green-600 font-semibold mb-2">Task updated successfully!</p>
            <div class="text-sm text-gray-700 bg-gray-50 p-3 rounded-lg space-y-1">
              <p><strong>Completion Date:</strong> ${formatDate(newCompletionDate)}</p>
              <p><strong>Next Due Date:</strong> ${formatDate(newNextDueDate)}</p>
            </div>
            <div class="mt-6">
              <button type="button" onclick="closeModal()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Close</button>
            </div>
          </div>
        `);
      }, 300);
    };
  }

  // ====================================================================
  // 9. EMAIL REMINDER FUNCTIONS
  // ====================================================================

  function getTasksNeedingReminders() {
    const overdue = [];
    const dueSoon = [];

    clients.forEach(client => {
      client.tasks.forEach(task => {
        const days = getDaysRemaining(task.nextDue);
        const taskInfo = {
          clientName: client.clientName,
          contactPerson: client.contactPerson,
          email: client.email,
          phone: client.phone,
          taskType: task.type,
          taskDetails: task.details,
          lastCompleted: formatDate(task.lastCompleted),
          nextDue: formatDate(task.nextDue),
          daysRemaining: days
        };

        if (days < 0) {
          overdue.push(taskInfo);
        } else if (days <= 14) {
          dueSoon.push(taskInfo);
        }
      });
    });

    return { overdue, dueSoon };
  }

  function generateReminderEmailContent() {
    const { overdue, dueSoon } = getTasksNeedingReminders();
    
    let content = 'PM and Stat Testing Schedule - Reminder Report\n';
    content += '============================================================\n';
    content += `Generated: ${new Date().toLocaleString()}\n\n`;

    if (overdue.length > 0) {
      content += `‚ö†Ô∏è OVERDUE TASKS (${overdue.length})\n`;
      content += '------------------------------------------------------------\n';
      overdue.forEach((task, index) => {
        content += `\n${index + 1}. ${task.clientName}\n`;
        content += `   Task: ${task.taskType} - ${task.taskDetails || 'N/A'}\n`;
        content += `   Contact: ${task.contactPerson || 'N/A'} (${task.email})\n`;
        content += `   Last Completed: ${task.lastCompleted}\n`;
        content += `   Due Date: ${task.nextDue}\n`;
        content += `   Days Remaining: ${task.daysRemaining}\n`;
      });
      content += '\n';
    }

    if (overdue.length === 0 && dueSoon.length === 0) {
      content += '‚úÖ No tasks require immediate attention.\n';
      content += 'All tasks are in date with more than 14 days remaining.\n';
    }

    content += '\n============================================================\n';
    content += 'Please review and schedule necessary inspections/testing.\n';

    return content;
  }

  function sendManualReminder() {
    const { overdue, dueSoon } = getTasksNeedingReminders();
    
    if (overdue.length === 0 && dueSoon.length === 0) {
      openModal('No Reminders Needed', `
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
          <p class="text-green-600 font-semibold">All tasks are in date!</p>
          <p class="text-sm text-gray-600 mt-2">No tasks are overdue or due within the next 14 days.</p>
          <div class="mt-6">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Close</button>
          </div>
        </div>
      `);
      return;
    }

    const emailBody = generateReminderEmailContent();
    const subject = `PM & Testing Schedule Reminder - ${overdue.length} Overdue, ${dueSoon.length} Due Soon`;
    const toEmail = reminderEmails.length > 0 ? reminderEmails[0] : '';
    const mailtoLink = `mailto:${toEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
    window.location.href = mailtoLink;
  }

  async function sendEmailJsReminder() {
    if (!emailJsServiceId || !emailJsTemplateId || !emailJsPublicKey) {
      openModal('EmailJS Not Configured', `
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
          </div>
          <p class="text-gray-800 font-semibold mb-3">EmailJS is not configured</p>
          <p class="text-sm text-gray-600 mb-4">To use automated email sending, you need to:</p>
          <ol class="text-left text-sm text-gray-700 space-y-2 mb-6 max-w-md mx-auto">
            <li>1. Create a free account at <a href="https://www.emailjs.com" target="_blank" class="text-indigo-600 hover:underline">emailjs.com</a></li>
            <li>2. Set up an email service and template</li>
            <li>3. Enter your EmailJS credentials in Settings</li>
          </ol>
          <div class="flex gap-3 justify-center">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
            <button type="button" onclick="closeModal(); openReminderSettings();" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Open Settings</button>
          </div>
        </div>
      `);
      return;
    }

    const { overdue, dueSoon } = getTasksNeedingReminders();
    
    if (overdue.length === 0 && dueSoon.length === 0) {
      openModal('No Reminders Needed', `
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
          <p class="text-green-600 font-semibold">All tasks are in date!</p>
          <p class="text-sm text-gray-600 mt-2">No tasks are overdue or due within the next 14 days.</p>
          <div class="mt-6">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Close</button>
          </div>
        </div>
      `);
      return;
    }

    openModal('Sending Reminder...', `
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
          <i data-lucide="loader" class="w-6 h-6 text-indigo-600 animate-spin"></i>
        </div>
        <p class="text-gray-700">Sending email reminder...</p>
      </div>
    `);

    try {
      if (typeof emailjs === 'undefined') {
        await loadEmailJsScript();
      }

      emailjs.init(emailJsPublicKey);
      const emailContent = generateReminderEmailContent();
      
      const sendPromises = reminderEmails.map(email => 
        emailjs.send(emailJsServiceId, emailJsTemplateId, {
          to_email: email,
          subject: `PM & Testing Schedule Reminder - ${overdue.length} Overdue, ${dueSoon.length} Due Soon`,
          message: emailContent,
          overdue_count: overdue.length,
          due_soon_count: dueSoon.length
        })
      );

      await Promise.all(sendPromises);

      openModal('Reminder Sent Successfully', `
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
          <p class="text-green-600 font-semibold mb-3">Email reminder sent successfully!</p>
          <p class="text-sm text-gray-600">Sent to ${reminderEmails.length} recipient(s):</p>
          <p class="text-sm text-gray-700 mt-2">${reminderEmails.join(', ')}</p>
          <div class="mt-4 p-3 bg-gray-50 rounded-lg text-left text-sm">
            <p class="font-semibold text-gray-700">Summary:</p>
            <p class="text-red-600">‚Ä¢ ${overdue.length} overdue task(s)</p>
            <p class="text-orange-600">‚Ä¢ ${dueSoon.length} task(s) due within 14 days</p>
          </div>
          <div class="mt-6">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Close</button>
          </div>
        </div>
      `);
    } catch (error) {
      console.error('EmailJS error:', error);
      openModal('Email Send Failed', `
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
            <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
          </div>
          <p class="text-red-600 font-semibold mb-3">Failed to send email</p>
          <p class="text-sm text-gray-600 mb-2">Error: ${error.text || error.message || 'Unknown error'}</p>
          <p class="text-xs text-gray-500 mb-4">Please check your EmailJS configuration in Settings.</p>
          <div class="flex gap-3 justify-center">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Close</button>
            <button type="button" onclick="closeModal(); openReminderSettings();" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Check Settings</button>
          </div>
        </div>
      `);
    }
  }

  function loadEmailJsScript() {
    return new Promise((resolve, reject) => {
      if (typeof emailjs !== 'undefined') {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  function showReminderOptions() {
    const { overdue, dueSoon } = getTasksNeedingReminders();
    
    const innerHtml = `
      <div>
        <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border border-purple-200">
          <h4 class="font-bold text-gray-800 mb-2">üìä Reminder Summary</h4>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
              <p class="text-red-700 font-bold text-2xl">${overdue.length}</p>
              <p class="text-red-600 text-xs">Overdue Tasks</p>
            </div>
            <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
              <p class="text-orange-700 font-bold text-2xl">${dueSoon.length}</p>
              <p class="text-orange-600 text-xs">Due Within 14 Days</p>
            </div>
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">Choose how you'd like to send reminder emails:</p>
        <div class="space-y-3">
          <button onclick="sendManualReminder(); closeModal();" class="w-full flex items-start p-4 bg-white border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition text-left">
            <div class="flex-shrink-0 mt-1">
              <i data-lucide="mail" class="w-6 h-6 text-indigo-600"></i>
            </div>
            <div class="ml-3 flex-1">
              <p class="font-semibold text-gray-900">üìß Open Email Client (Manual)</p>
              <p class="text-xs text-gray-600 mt-1">Opens your default email application with a pre-filled reminder message. You can review and send it manually.</p>
              <span class="inline-block mt-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded">‚úì Works immediately</span>
            </div>
          </button>
          <button onclick="sendEmailJsReminder(); closeModal();" class="w-full flex items-start p-4 bg-white border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition text-left">
            <div class="flex-shrink-0 mt-1">
              <i data-lucide="zap" class="w-6 h-6 text-purple-600"></i>
            </div>
            <div class="ml-3 flex-1">
              <p class="font-semibold text-gray-900">‚ö° Send via EmailJS (Automated)</p>
              <p class="text-xs text-gray-600 mt-1">Automatically sends emails to all recipients configured in Settings. Requires EmailJS setup.</p>
              <span class="inline-block mt-2 text-xs px-2 py-1 ${emailJsServiceId ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded">
                ${emailJsServiceId ? '‚úì Configured' : '‚ö† Setup required'}
              </span>
            </div>
          </button>
        </div>
        ${reminderEmails.length === 0 ? `
          <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-xs text-yellow-800">
              <strong>‚ö†Ô∏è No recipients configured.</strong> Add email addresses in Settings to specify who should receive reminders.
            </p>
          </div>
        ` : `
          <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-xs text-blue-800">
              <strong>Recipients:</strong> ${reminderEmails.join(', ')}
            </p>
          </div>
        `}
        <div class="mt-6 flex justify-end">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
        </div>
      </div>
    `;
    
    openModal('Send Reminder Email', innerHtml);
  }

  // ====================================================================
  // 10. REMINDER SETTINGS
  // ====================================================================

  function openReminderSettings() {
    renderSettingsModal();
  }

  function renderSettingsModal() {
    const innerHtml = `
      <form id="reminderSettingsForm">
        <div class="mb-6">
          <h4 class="text-xl font-bold text-gray-800 mb-3">Email Reminder Recipients</h4>
          <p class="text-sm text-gray-600 mb-4">Enter email addresses, separated by commas, who should receive reminder reports about upcoming tasks.</p>
          <div>
            <label for="emailsInput" class="block text-sm font-medium text-gray-700">Recipient Emails</label>
            <textarea id="emailsInput" rows="4" placeholder="manager@company.com, maintenance@company.com" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">${reminderEmails.join(', ')}</textarea>
          </div>
        </div>
        <div class="border-t pt-6 mb-6">
          <h4 class="text-xl font-bold text-gray-800 mb-3">EmailJS Configuration (Optional)</h4>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="text-xs text-blue-800 mb-2">
                  <strong>What is EmailJS?</strong> EmailJS allows you to send automated emails directly from your browser without needing a backend server.
                </p>
                <p class="text-xs text-blue-700">
                  To set up EmailJS: <a href="https://www.emailjs.com" target="_blank" class="underline font-semibold">Create a free account</a>, 
                  set up an email service and template, then enter your credentials below.
                </p>
              </div>
              <button type="button" onclick="showEmailJsHelp()" class="ml-2 px-3 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 transition flex items-center flex-shrink-0">
                <i data-lucide="help-circle" class="w-3 h-3 mr-1"></i> Help
              </button>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <label for="serviceIdInput" class="block text-sm font-medium text-gray-700">Service ID</label>
              <input type="text" id="serviceIdInput" value="${emailJsServiceId}" placeholder="service_xxxxxxx" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
              <label for="templateIdInput" class="block text-sm font-medium text-gray-700">Template ID</label>
              <input type="text" id="templateIdInput" value="${emailJsTemplateId}" placeholder="template_xxxxxxx" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
              <label for="publicKeyInput" class="block text-sm font-medium text-gray-700">Public Key</label>
              <input type="text" id="publicKeyInput" value="${emailJsPublicKey}" placeholder="xxxxxxxxxxxxxxxxxxxx" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
          </div>
          <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-xs text-yellow-800">
              <strong>EmailJS Template Variables:</strong> Your template should include these variables: <code>{{to_email}}</code>, <code>{{subject}}</code>, <code>{{message}}</code>, <code>{{overdue_count}}</code>, <code>{{due_soon_count}}</code>
            </p>
          </div>
        </div>
        <div class="pt-6 flex justify-end gap-3 border-t">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 flex items-center">
            <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Settings
          </button>
        </div>
      </form>
    `;
    openModal('Reminder Settings', innerHtml);

    document.getElementById('reminderSettingsForm').onsubmit = (e) => {
      e.preventDefault();
      saveReminderSettings();
    };
  }

  function saveReminderSettings() {
    const form = document.getElementById('reminderSettingsForm');
    const emailsText = form.querySelector('#emailsInput').value.trim();
    
    const newEmails = emailsText
      .split(',')
      .map(email => email.trim().toLowerCase())
      .filter(email => email.match(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/));

    reminderEmails = newEmails;
    emailJsServiceId = form.querySelector('#serviceIdInput').value.trim();
    emailJsTemplateId = form.querySelector('#templateIdInput').value.trim();
    emailJsPublicKey = form.querySelector('#publicKeyInput').value.trim();
    
    closeModal();
    saveAndRender();
  }

  // ====================================================================
  // EMAILJS HELP MODAL
  // ====================================================================

  function showEmailJsHelp() {
    const helpHtml = `
      <div class="space-y-6">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
          <h4 class="font-bold text-indigo-900 mb-2 flex items-center">
            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
            How to Set Up EmailJS for Automatic Reminders
          </h4>
          <p class="text-sm text-gray-700">Follow these steps to configure automated email reminders for your PM and testing schedule.</p>
        </div>

        <!-- Step 1 -->
        <div class="border-l-4 border-indigo-500 pl-4">
          <h5 class="font-bold text-gray-800 mb-2">üîê Step 1: Create a Free EmailJS Account</h5>
          <p class="text-sm text-gray-700 mb-2">Go to <a href="https://www.emailjs.com" target="_blank" class="text-indigo-600 hover:underline font-semibold">https://www.emailjs.com</a> and sign up for a free account.</p>
          <div class="bg-green-50 border border-green-200 rounded p-2 text-xs text-green-800">
            <strong>‚úì Free Plan Includes:</strong> 200 emails per month - perfect for small businesses!
          </div>
        </div>

        <!-- Step 2 -->
        <div class="border-l-4 border-purple-500 pl-4">
          <h5 class="font-bold text-gray-800 mb-2">üîë Step 2: Get Your Public Key</h5>
          <ol class="text-sm text-gray-700 space-y-1 ml-4 list-decimal">
            <li>After logging in, click <strong>Account</strong> (top right) ‚Üí <strong>General</strong></li>
            <li>You'll see your <strong>Public Key</strong> - copy this</li>
            <li>It looks like: <code class="bg-gray-100 px-1 rounded">abcdefghij1234567890</code></li>
          </ol>
        </div>

        <!-- Step 3 -->
        <div class="border-l-4 border-blue-500 pl-4">
          <h5 class="font-bold text-gray-800 mb-2">üìß Step 3: Set Up an Email Service</h5>
          <ol class="text-sm text-gray-700 space-y-1 ml-4 list-decimal">
            <li>Go to <strong>Email Services</strong> in the left sidebar</li>
            <li>Click <strong>Add New Service</strong></li>
            <li>Choose your email provider (Gmail, Outlook, etc.)</li>
            <li>Follow the setup instructions to connect your email account</li>
            <li>After setup, copy the <strong>Service ID</strong></li>
            <li>It looks like: <code class="bg-gray-100 px-1 rounded">service_xxxxxxx</code></li>
          </ol>
        </div>

        <!-- Step 4 -->
        <div class="border-l-4 border-orange-500 pl-4">
          <h5 class="font-bold text-gray-800 mb-2">üìã Step 4: Create an Email Template</h5>
          <ol class="text-sm text-gray-700 space-y-2 ml-4 list-decimal">
            <li>Go to <strong>Email Templates</strong> in the left sidebar</li>
            <li>Click <strong>Create New Template</strong></li>
            <li>Set up your template with these variables:
              <div class="mt-2 bg-gray-50 border border-gray-200 rounded p-3 text-xs">
                <p class="font-semibold mb-1">Subject:</p>
                <code class="block bg-white p-2 rounded mb-3">{{subject}}</code>
                
                <p class="font-semibold mb-1">Content/Body:</p>
                <code class="block bg-white p-2 rounded mb-2">{{message}}</code>
                
                <p class="text-gray-600 mt-2">Optional - You can also add:</p>
                <code class="block bg-white p-2 rounded mt-1">Summary:<br/>- Overdue tasks: {{overdue_count}}<br/>- Due soon: {{due_soon_count}}</code>
              </div>
            </li>
            <li class="mt-2">Save the template and copy the <strong>Template ID</strong></li>
            <li>It looks like: <code class="bg-gray-100 px-1 rounded">template_xxxxxxx</code></li>
          </ol>
        </div>

        <!-- Step 5 -->
        <div class="border-l-4 border-green-500 pl-4">
          <h5 class="font-bold text-gray-800 mb-2">‚úÖ Step 5: Enter Credentials in Settings</h5>
          <p class="text-sm text-gray-700 mb-2">Back in this app, click the <strong>Settings</strong> button and enter:</p>
          <ul class="text-sm text-gray-700 space-y-1 ml-4 list-disc">
            <li><strong>Service ID:</strong> <code class="bg-gray-100 px-1 rounded text-xs">service_xxxxxxx</code></li>
            <li><strong>Template ID:</strong> <code class="bg-gray-100 px-1 rounded text-xs">template_xxxxxxx</code></li>
            <li><strong>Public Key:</strong> Your public key from Step 2</li>
          </ul>
        </div>

        <!-- Done -->
        <div class="bg-green-50 border border-green-300 rounded-lg p-4">
          <p class="text-green-800 font-semibold flex items-center">
            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
            You're All Set!
          </p>
          <p class="text-sm text-green-700 mt-1">Once configured, the "Send Reminder" button will automatically email all your configured recipients with overdue and upcoming task reminders.</p>
        </div>

        <!-- Close Button -->
        <div class="flex justify-end pt-4 border-t">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">
            Got It!
          </button>
        </div>
      </div>
    `;
    
    openModal('üìö EmailJS Setup Guide', helpHtml);
  }

  // ====================================================================
  // 11. START FRESH FUNCTIONALITY
  // ====================================================================

  function confirmStartFresh() {
    const innerHtml = `
      <div class="text-center mb-6">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mb-4">
          <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Clear All Data?</h3>
        <p class="text-gray-600">This will permanently delete:</p>
        <ul class="text-left mt-3 space-y-1 text-sm text-gray-700">
          <li class="flex items-center"><i data-lucide="check" class="w-4 h-4 mr-2 text-orange-600"></i> All ${clients.length} client records</li>
          <li class="flex items-center"><i data-lucide="check" class="w-4 h-4 mr-2 text-orange-600"></i> All scheduled tasks</li>
          <li class="flex items-center"><i data-lucide="check" class="w-4 h-4 mr-2 text-orange-600"></i> Reminder email settings</li>
        </ul>
        <p class="text-sm text-red-600 font-semibold mt-4">‚ö†Ô∏è This action cannot be undone!</p>
        <p class="text-xs text-gray-500 mt-2">Consider exporting your data first as a backup.</p>
      </div>
      <div class="flex justify-center gap-3">
        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
        <button type="button" onclick="executeStartFresh()" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 flex items-center">
          <i data-lucide="trash" class="w-5 h-5 mr-2"></i> Yes, Clear All Data
        </button>
      </div>
    `;
    openModal('Start Fresh', innerHtml);
  }

  function executeStartFresh() {
    clients = [];
    reminderEmails = [];
    localStorage.removeItem('scheduleData');
    closeModal();
    saveAndRender();
    setTimeout(() => {
      openModal('Data Cleared', `
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
          <p class="text-green-600 font-semibold">All data has been cleared successfully!</p>
          <p class="text-sm text-gray-600 mt-2">You can now start fresh with new client records.</p>
          <div class="mt-6">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Get Started</button>
          </div>
        </div>
      `);
    }, 300);
  }

  // ====================================================================
  // 12. IMPORT LOGIC
  // ====================================================================

  const importFileInput = document.getElementById('importFileInput');
  document.getElementById('importBtn').onclick = () => {
    importFileInput.click();
  };

  importFileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.type !== 'application/json') {
      openModal('Error', '<p class="text-red-600">Please select a valid JSON file.</p>');
      e.target.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const importedData = JSON.parse(ev.target.result);
        
        if (!importedData.clients || !Array.isArray(importedData.clients)) {
          openModal('Import Error', '<p class="text-red-600">JSON file is missing the required "clients" array.</p>');
          return;
        }

        clients = importedData.clients;
        if (importedData.logoBase64) logoBase64 = importedData.logoBase64;
        if (Array.isArray(importedData.reminderEmails)) reminderEmails = importedData.reminderEmails;
        if (importedData.emailJsServiceId) emailJsServiceId = importedData.emailJsServiceId;
        if (importedData.emailJsTemplateId) emailJsTemplateId = importedData.emailJsTemplateId;
        if (importedData.emailJsPublicKey) emailJsPublicKey = importedData.emailJsPublicKey;

        openModal('Import Successful', `<p class="text-green-600">Successfully imported ${clients.length} client records.</p>`);
        saveAndRender();
        renderHeaderLogo();
      } catch (error) {
        openModal('Import Error', `<p class="text-red-600">Failed to parse JSON content. Error: ${error.message}</p>`);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  // ====================================================================
  // 13. EXPORT LOGIC
  // ====================================================================
  
  function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function escapeCsvValue(value) {
    if (value === null || value === undefined) return '';
    const strValue = String(value);
    if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
      return '"' + strValue.replace(/"/g, '""') + '"';
    }
    return strValue;
  }

  function getFilteredClients() {
    const query = searchTerm.toLowerCase();
    
    let filteredClients = clients.filter(client =>
      client.clientName.toLowerCase().includes(query) ||
      client.email.toLowerCase().includes(query) ||
      client.tasks.some(task => task.type.toLowerCase().includes(query) || task.details.toLowerCase().includes(query))
    );

    if (filterMode === 'overdue') {
      filteredClients = filteredClients.map(client => {
        const overdueTasks = client.tasks.filter(task => {
          const daysRemaining = getDaysRemaining(task.nextDue);
          return daysRemaining < 0;
        });
        if (overdueTasks.length > 0) {
          return { ...client, tasks: overdueTasks };
        }
        return null;
      }).filter(client => client !== null);
    } else if (filterMode === 'dueSoon') {
      filteredClients = filteredClients.map(client => {
        const dueSoonTasks = client.tasks.filter(task => {
          const daysRemaining = getDaysRemaining(task.nextDue);
          return daysRemaining >= 0 && daysRemaining <= 14;
        });
        if (dueSoonTasks.length > 0) {
          return { ...client, tasks: dueSoonTasks };
        }
        return null;
      }).filter(client => client !== null);
    } else if (filterMode === 'inDate') {
      filteredClients = filteredClients.map(client => {
        const inDateTasks = client.tasks.filter(task => {
          const daysRemaining = getDaysRemaining(task.nextDue);
          return daysRemaining >= 0;
        });
        if (inDateTasks.length > 0) {
          return { ...client, tasks: inDateTasks };
        }
        return null;
      }).filter(client => client !== null);
    }

    return filteredClients;
  }

  function exportData(format) {
    document.getElementById('exportDropdownMenu').classList.add('hidden');
    const timestamp = new Date().toISOString().substring(0, 10);
    const filenameBase = `pm_schedule_${timestamp}`;
    const filteredClients = getFilteredClients();

    if (format === 'json') {
      const dataToExport = {
        clients: filteredClients,
        logoBase64,
        reminderEmails,
        emailJsServiceId,
        emailJsTemplateId,
        emailJsPublicKey,
        savedDate: new Date().toISOString(),
        filterApplied: filterMode === 'overdue' ? 'Overdue only' : 
                       filterMode === 'dueSoon' ? 'Due within 14 days' : 
                       filterMode === 'inDate' ? 'In date only' : 'None'
      };
      downloadFile(`${filenameBase}.json`, JSON.stringify(dataToExport, null, 2), 'application/json');
    } else if (format === 'csv') {
      const reportData = filteredClients.flatMap(client => 
        client.tasks.length > 0
          ? client.tasks.map(task => ({ 
              'Client Name': client.clientName,
              'Contact Person': client.contactPerson || 'N/A',
              'Contact Number': client.phone || 'N/A',
              'Job Type': task.type,
              'Task Details': task.details || 'N/A',
              'Last Test Completed': task.lastCompleted,
              'Next Due Date': task.nextDue,
              'Status': getTaskStatus(getDaysRemaining(task.nextDue)).statusText,
            }))
          : [{ 
              'Client Name': client.clientName,
              'Contact Person': client.contactPerson || 'N/A',
              'Contact Number': client.phone || 'N/A',
              'Job Type': 'N/A',
              'Task Details': 'N/A',
              'Last Test Completed': 'N/A',
              'Next Due Date': 'N/A',
              'Status': 'N/A',
            }]
      );
      const csv = convertToCsv(reportData);
      downloadFile(`${filenameBase}.csv`, csv, 'text/csv;charset=utf-8;');
    } else if (format === 'aroflo') {
      const currentDate = new Date().toISOString().substring(0, 10);
      const arofloData = filteredClients.flatMap(client => 
        client.tasks.length > 0
          ? client.tasks.map(task => ({
              'Client': client.clientName,
              'Task': task.details || 'N/A',
              'Task Type': 'Electrical',
              'Asset': '',
              'Assigned To': '',
              'Cust ON': '',
              'Location': '',
              'Priority Short Description': '',
              'Project': '',
              'Stage': '',
              'Contact Name': '',
              'Contact Phone': '',
              'Description': `${task.type} - ${task.details || 'N/A'}`,
              'Due_Date': task.nextDue,
              'Requested_Date': currentDate,
              'Custom Field 1': '',
              'Custom Field 2': ''
            }))
          : []
      );
      const csv = convertToCsv(arofloData);
      downloadFile(`aroflo_import_${timestamp}.csv`, csv, 'text/csv;charset=utf-8;');
    } else if (format === 'excel') {
      const reportData = filteredClients.flatMap(client => 
        client.tasks.length > 0
          ? client.tasks.map(task => ({ 
              'Client Name': client.clientName,
              'Contact Person': client.contactPerson || 'N/A',
              'Contact Number': client.phone || 'N/A',
              'Job Type': task.type,
              'Task Details': task.details || 'N/A',
              'Last Test Completed': task.lastCompleted,
              'Next Due Date': task.nextDue,
              'Status': getTaskStatus(getDaysRemaining(task.nextDue)).statusText,
            }))
          : [{ 
              'Client Name': client.clientName,
              'Contact Person': client.contactPerson || 'N/A',
              'Contact Number': client.phone || 'N/A',
              'Job Type': 'N/A',
              'Task Details': 'N/A',
              'Last Test Completed': 'N/A',
              'Next Due Date': 'N/A',
              'Status': 'N/A',
            }]
      );
      const xml = convertToExcelXml(reportData);
      downloadFile(`${filenameBase}.xls`, xml, 'application/vnd.ms-excel');
    } else if (format === 'pdf') {
      const printLogo = document.getElementById('printLogo');
      const printDate = document.getElementById('printDate');
      if (printLogo) {
        printLogo.src = logoBase64 || "https://placehold.co/120x120/d0e0ff/333?text=LOGO";
      }
      if (printDate) {
        const now = new Date();
        printDate.textContent = `Generated on: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}`;
      }
      window.print();
    }
  }

  function convertToCsv(data) {
    if (data.length === 0) return '';
    const headers = Object.keys(data[0]);
    const csvRows = [
      headers.map(h => escapeCsvValue(h)).join(','),
      ...data.map(row => 
        headers.map(fieldName => escapeCsvValue(row[fieldName])).join(',')
      )
    ];
    return csvRows.join('\r\n');
  }

  function convertToExcelXml(data) {
    if (data.length === 0) {
      return '<html><body><table><tr><td>No data</td></tr></table></body></html>';
    }
    
    const headers = Object.keys(data[0]);
    
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">\n';
    html += '<head>\n';
    html += '<meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">\n';
    html += '<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>\n';
    html += '<x:Name>Schedule</x:Name>\n';
    html += '<x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>\n';
    html += '</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->\n';
    html += '<style>\n';
    html += 'table { border-collapse: collapse; width: 100%; }\n';
    html += 'th { background-color: #4472C4; color: white; font-weight: bold; padding: 8px; text-align: left; border: 1px solid #ddd; }\n';
    html += 'td { padding: 8px; text-align: left; border: 1px solid #ddd; }\n';
    html += '.status-overdue { color: #C00000; font-weight: bold; }\n';
    html += '.status-indate { color: #006600; font-weight: bold; }\n';
    html += '</style>\n';
    html += '</head>\n';
    html += '<body>\n';
    html += '<table>\n';
    
    html += '<tr>\n';
    headers.forEach(h => {
      html += `<th>${escapeHtml(h)}</th>\n`;
    });
    html += '</tr>\n';

    data.forEach(row => {
      html += '<tr>\n';
      headers.forEach(header => {
        let value = row[header];
        let cellClass = '';
        
        if (header === 'Status') {
          if (value === 'OVERDUE') {
            cellClass = ' class="status-overdue"';
          } else if (value === 'IN DATE') {
            cellClass = ' class="status-indate"';
          }
        }
        
        html += `<td${cellClass}>${escapeHtml(value)}</td>\n`;
      });
      html += '</tr>\n';
    });

    html += '</table>\n';
    html += '</body>\n';
    html += '</html>';
    
    return html;
  }

  // ====================================================================
  // 14. EVENT LISTENERS & INITIALIZATION
  // ====================================================================

  document.getElementById('addClientBtn').onclick = () => handleOpenForm(null);
  document.getElementById('reminderSettingsBtn').onclick = openReminderSettings;
  document.getElementById('sendReminderBtn').onclick = showReminderOptions;
  document.getElementById('startFreshBtn').onclick = confirmStartFresh;

  searchInput.oninput = (e) => {
    searchTerm = e.target.value;
    renderTable();
  };

  function filterOverdue() {
    filterMode = 'overdue';
    searchTerm = '';
    searchInput.value = '';
    renderTable();
    if (window.lucide) { window.lucide.createIcons(); }
  }

  function filterDueSoon() {
    filterMode = 'dueSoon';
    searchTerm = '';
    searchInput.value = '';
    renderTable();
    if (window.lucide) { window.lucide.createIcons(); }
  }

  function filterInDate() {
    filterMode = 'inDate';
    searchTerm = '';
    searchInput.value = '';
    renderTable();
    if (window.lucide) { window.lucide.createIcons(); }
  }

  function clearFilters() {
    filterMode = 'all';
    searchTerm = '';
    searchInput.value = '';
    renderTable();
    if (window.lucide) { window.lucide.createIcons(); }
  }

  logoInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      logoBase64 = ev.target.result;
      renderHeaderLogo();
      saveToLocalStorage();
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  };

  function removeLogo() {
    logoBase64 = '';
    renderHeaderLogo();
    saveToLocalStorage();
  }

  document.getElementById('exportDropdownBtn').onclick = (e) => {
    e.stopPropagation();
    document.getElementById('exportDropdownMenu').classList.toggle('hidden');
  };

  document.addEventListener('click', (e) => {
    if (!document.getElementById('exportDropdownContainer').contains(e.target)) {
      document.getElementById('exportDropdownMenu').classList.add('hidden');
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded');
    loadFromLocalStorage();
    console.log('After loading, clients:', clients);
    
    if (clients.length === 0) {
      console.log('No clients found, adding sample data');
      clients = [
        {
          id: generateId(),
          clientName: 'ABC Manufacturing Ltd', contactPerson: 'John Smith', email: 'john@abcmfg.com', phone: '555-0101',
          tasks: [
            { id: generateId(), type: 'PM', details: 'Annual Fire Alarm Test', lastCompleted: '2024-01-15', nextDue: '2025-01-15' },
            { id: generateId(), type: 'Stat Testing', details: 'Emergency Lighting Test', lastCompleted: '2024-10-18', nextDue: '2024-11-18' }
          ]
        },
        {
          id: generateId(),
          clientName: 'XYZ Office Complex', contactPerson: 'Sarah Johnson', email: 'sarah@xyzoffice.com', phone: '555-0102',
          tasks: [
            { id: generateId(), type: 'Maintenance', details: 'HVAC System Service', lastCompleted: '2023-10-01', nextDue: '2024-10-01' }
          ]
        },
        {
          id: generateId(),
          clientName: 'Local School District', contactPerson: 'Mike Brown', email: 'mike@schooldistrict.edu', phone: '555-0103',
          tasks: []
        }
      ];
      saveToLocalStorage();
      console.log('Sample data added');
    }
    
    if (window.lucide) { window.lucide.createIcons(); }
    renderHeaderLogo();
    updateReminderSummary();
    renderTable();
    console.log('Initial render complete');
  });

</script>
</body>
</html>)
